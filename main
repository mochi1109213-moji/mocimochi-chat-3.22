<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Ultimate Chat - Admin & Bot & Log Ver</title>
    <style>
      :root {
        --main-blue: #0084ff;
        --bg-gray: #f0f2f5;
        --side-width: 260px;
        --online-green: #52c41a;
        --offline-gray: #ccc;
      }
      body {
        font-family: sans-serif;
        background: var(--bg-gray);
        margin: 0;
        display: flex;
        height: 100vh;
        height: 100dvh;
        overflow: hidden;
      }
      /* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ */
      #authOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .auth-box {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        width: 300px;
        text-align: center;
      }
      .auth-box input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
      }
      .auth-btn {
        width: 100%;
        padding: 10px;
        background: var(--main-blue);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 5px;
      }

      /* „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„Éà */
      .sidebar {
        width: var(--side-width);
        background: white;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        z-index: 100;
      }
      .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid #eee;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }
      .main-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      /* „Ç¢„Éä„Ç¶„É≥„Çπ„Éê„Éº */
      #announcementBar {
        display: none;
        background: #ff4d4f;
        color: white;
        padding: 8px;
        text-align: center;
        font-size: 13px;
        font-weight: bold;
        z-index: 1000;
      }

      #messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .list-title {
        font-size: 11px;
        color: #999;
        margin: 15px 0 5px 5px;
        font-weight: bold;
      }
      .item-btn {
        width: 100%;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        box-sizing: border-box;
      }
      .item-btn:hover {
        background: #f0f2f5;
      }
      .active-item {
        background: #e7f3ff;
        color: var(--main-blue);
        font-weight: bold;
      }

      /* „É°„ÉÉ„Çª„Éº„Ç∏„Éê„Éñ„É´ */
      .msg-box {
        display: flex;
        gap: 10px;
        max-width: 80%;
      }
      .my-msg {
        align-self: flex-end;
        flex-direction: row-reverse;
      }
      .bubble {
        padding: 10px 15px;
        border-radius: 18px;
        background: white;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        font-size: 14px;
        word-break: break-all;
        position: relative;
      }
      .my-msg .bubble {
        background: var(--main-blue);
        color: white;
      }
      .icon-img {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        background: #ddd;
        flex-shrink: 0;
      }

      /* ÁâπÊÆä„É°„ÉÉ„Çª„Éº„Ç∏ */
      .system-msg {
        align-self: center;
        background: rgba(0, 0, 0, 0.05);
        color: #777;
        font-size: 11px;
        padding: 4px 12px;
        border-radius: 10px;
        margin: 5px 0;
      }
      .log-msg {
        font-size: 11px;
        color: #888;
        border-left: 2px solid #ddd;
        padding-left: 5px;
        margin: 2px 0;
        font-family: monospace;
      }

      /* ÁÆ°ÁêÜËÄÖ„Éë„Éç„É´ */
      #adminLog {
        display: none;
        height: 120px;
        overflow-y: auto;
        padding: 5px;
        background: #f9f9f9;
        border-top: 1px solid #eee;
      }

      /* „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº */
      .context-menu {
        position: fixed;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        display: none;
        flex-direction: column;
        z-index: 1000;
        min-width: 150px;
      }
      .menu-item {
        padding: 12px 16px;
        font-size: 13px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      #menuOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        z-index: 999;
      }

      .input-wrapper {
        flex-shrink: 0;
        background: var(--bg-gray);
        padding: 10px 15px 15px 15px;
      }
      .input-area {
        background: white;
        padding: 10px 15px;
        border-radius: 30px;
        display: flex;
        gap: 10px;
        align-items: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .input-area input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div id="authOverlay">
      <div class="auth-box">
        <h2 id="authTitle">„É≠„Ç∞„Ç§„É≥</h2>
        <input type="text" id="authId" placeholder="„É¶„Éº„Ç∂„ÉºID" />
        <input type="password" id="authPw" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" />
        <button class="auth-btn" id="authSubmitBtn">„É≠„Ç∞„Ç§„É≥</button>
        <div
          class="switch-auth"
          id="switchAuthBtn"
          style="
            margin-top: 15px;
            font-size: 12px;
            color: var(--main-blue);
            cursor: pointer;
            text-decoration: underline;
          "
        >
          Êñ∞Ë¶èÁôªÈå≤„ÅØ„Åì„Å°„Çâ
        </div>
      </div>
    </div>

    <div id="menuOverlay"></div>
    <div id="msgMenu" class="context-menu">
      <div id="menuReply" class="menu-item">Ëøî‰ø°„Åô„Çã</div>
      <div
        id="menuDelete"
        class="menu-item"
        style="color: red; font-weight: bold"
      >
        ÂâäÈô§„Åô„Çã
      </div>
    </div>

    <div class="sidebar">
      <div class="sidebar-header">
        <span>Ultimate Chat</span>
        <button
          id="addRoomBtn"
          style="
            border: none;
            background: none;
            font-size: 20px;
            color: var(--main-blue);
            cursor: pointer;
          "
        >
          ‚äï
        </button>
      </div>
      <div class="sidebar-content">
        <div class="list-title">ÈÉ®Â±ã</div>
        <div id="roomList"></div>
        <div class="list-title">ÂèÇÂä†ËÄÖ</div>
        <div id="userList"></div>
        <div class="list-title" id="logTitle" style="display: none">
          ÁÆ°ÁêÜËÄÖ„É≠„Ç∞
        </div>
        <div id="adminLog"></div>
      </div>
      <div
        id="settingsBtn"
        style="
          padding: 15px;
          text-align: center;
          cursor: pointer;
          font-size: 12px;
          color: var(--main-blue);
          border-top: 1px solid #eee;
        "
      >
        ‚öô Ë®≠ÂÆö
      </div>
      <div
        id="adminPanel"
        style="
          display: none;
          padding: 10px;
          background: #fff1f0;
          font-size: 10px;
          color: red;
          text-align: center;
        "
      >
        üëë ÁÆ°ÁêÜËÄÖ„É¢„Éº„Éâ
      </div>
    </div>

    <div class="main-container">
      <div id="announcementBar"></div>
      <div id="messages"></div>
      <div class="input-wrapper">
        <div
          id="replyBox"
          style="
            display: none;
            background: #e0e0e0;
            padding: 8px;
            font-size: 12px;
            border-radius: 10px 10px 0 0;
          "
        >
          <span id="replyText"></span>
          <button
            onclick="cancelReply()"
            style="border: none; background: none; float: right"
          >
            √ó
          </button>
        </div>
        <div class="input-area">
          <input
            type="text"
            id="msgInput"
            placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ... (/cmd „Åß„Ç¢„Éä„Ç¶„É≥„Çπ)"
            autocomplete="off"
          />
          <button
            id="sendBtn"
            style="
              border: none;
              background: var(--main-blue);
              color: white;
              padding: 8px 15px;
              border-radius: 20px;
            "
          >
            ÈÄÅ‰ø°
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        get,
        onValue,
        remove,
        update,
        onDisconnect,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

      // --- CONFIG („ÅÇ„Å™„Åü„ÅÆ„ÇÇ„ÅÆ„Å´Â∑Æ„ÅóÊõø„Åà) ---
      const firebaseConfig = {
        apiKey: "AIzaSyCVoT10q21bNe7ks6DrLZWkl0JIJ2cIa0s",
        authDomain: "mochimochi-chat8.firebaseapp.com",
        databaseURL: "https://mochimochi-chat8-default-rtdb.firebaseio.com",
        projectId: "mochimochi-chat8",
        storageBucket: "mochimochi-chat8.firebasestorage.app",
        messagingSenderId: "722113120591",
        appId: "1:722113120591:web:f788ca0736e50d60581d3a",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // --- ÂÆöÊï∞ & Â§âÊï∞ ---
      const BOT_INFO = {
        uid: "bot-001",
        name: "„ÅäÂä©„ÅëBot",
        icon: "https://api.dicebear.com/7.x/bottts/svg?seed=Helper",
      };
      let myUid,
        myProfile,
        isAdmin = false,
        currentRoomId = "public",
        replyTo = null,
        isRegisterMode = false;

      // --- „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ---
      const addAdminLog = (action) => {
        const time = new Date().toLocaleTimeString();
        push(ref(db, "admin_logs"), {
          text: `[${time}] ${action}`,
          time: serverTimestamp(),
        });
      };

      const sendSystemMessage = (roomId, txt) => {
        push(ref(db, `chat_data/${roomId}`), {
          uid: "system",
          name: "System",
          text: txt,
          time: serverTimestamp(),
        });
      };

      const getBotResponse = (text) => {
        if (text.includes("„Éò„É´„Éó"))
          return "„Éª/cmd [ÊñáÁ´†] „Åß„Ç¢„Éä„Ç¶„É≥„Çπ(Admin)\n„Éª/nuke „ÅßÂÖ®Ê∂àÂéª(Admin)\n„Éª„ÄåÂç†„ÅÑ„Äç„ÅßÈÅãÂã¢";
        if (text.includes("Âç†„ÅÑ")) {
          const res = ["Â§ßÂêâ üåü", "Âêâ ‚ú®", "‰∏≠Âêâ üëç", "Âá∂ üíÄ"];
          return (
            "‰ªäÊó•„ÅÆÈÅãÂã¢„ÅØ..." + res[Math.floor(Math.random() * res.length)]
          );
        }
        if (text.includes("„Åì„Çì„Å´„Å°„ÅØ"))
          return "„Åì„Çì„Å´„Å°„ÅØÔºÅ‰Ωï„Åã„ÅäÊâã‰ºù„ÅÑ„Åó„Åæ„Åó„Çá„ÅÜ„ÅãÔºü";
        return null;
      };

      // --- Ë™çË®º„É≠„Ç∏„ÉÉ„ÇØ ---
      const authSubmitBtn = document.getElementById("authSubmitBtn");
      authSubmitBtn.onclick = async () => {
        const id = document.getElementById("authId").value.trim();
        const pw = document.getElementById("authPw").value.trim();
        if (!id || !pw) return alert("ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");

        const userRef = ref(db, `users/${id}`);
        const snap = await get(userRef);

        if (isRegisterMode) {
          if (snap.exists()) return alert("Êó¢„Å´Â≠òÂú®„Åó„Åæ„Åô");
          const newProf = {
            password: pw,
            name: id,
            icon: `https://api.dicebear.com/7.x/avataaars/svg?seed=${id}`,
            role: 0,
            lastLogin: Date.now(),
          };
          await set(userRef, newProf);
          loginSuccess(id, newProf);
        } else {
          if (!snap.exists() || snap.val().password !== pw)
            return alert("Ë™çË®ºÂ§±Êïó");
          loginSuccess(id, snap.val());
        }
      };

      function loginSuccess(uid, data) {
        myUid = uid;
        myProfile = data;
        document.getElementById("authOverlay").style.display = "none";
        update(ref(db, `users/${myUid}`), {
          status: "online",
          lastLogin: Date.now(),
        });
        onDisconnect(ref(db, `users/${myUid}`)).update({ status: "offline" });

        startApp();
        cleanOldData();
        sendSystemMessage("public", `${myProfile.name}„Åï„Çì„ÅåÂÖ•ÂÆ§„Åó„Åæ„Åó„Åü`);
      // Ê®©ÈôêÁõ£Ë¶ñ
      onValue(ref(db, `users/${myUid}/role`), (snap) => {
          const role = snap.val() || 0;
          isAdmin = role === 2;
          if (myProfile) myProfile.role = role; // „Éó„É≠„Éï„Ç£„Éº„É´ÂÜÖ„ÅÆrole„ÇÇÊõ¥Êñ∞
          document.getElementById("adminPanel").style.display = isAdmin ? "block" : "none";
          if (isAdmin) listenToLogs();
          renderRoomList();
        });
      }

      // --- 5Êó•„É´„Éº„É´ÊéÉÈô§ ---
      async function cleanOldData() {
        const cutoff = Date.now() - 5 * 24 * 60 * 60 * 1000;
        const chatSnap = await get(ref(db, "chat_data"));
        chatSnap.forEach((room) => {
          room.forEach((msg) => {
            if (msg.val().time < cutoff)
              remove(ref(db, `chat_data/${room.key}/${msg.key}`));
          });
        });
      }

      // --- „É°„Ç§„É≥„Ç¢„Éó„É™ ---
      function startApp() {
        // „Ç¢„Éä„Ç¶„É≥„ÇπÁõ£Ë¶ñ
        onValue(ref(db, "announcement"), (snap) => {
          const bar = document.getElementById("announcementBar");
          bar.style.display = snap.val() ? "block" : "none";
          if (snap.val()) bar.innerText = `üì¢ ${snap.val().text}`;
        });

        // Ê®©ÈôêÁõ£Ë¶ñ
        onValue(ref(db, `users/${myUid}/role`), (snap) => {
          isAdmin = snap.val() === 2;
          document.getElementById("adminPanel").style.display = isAdmin
            ? "block"
            : "none";
          if (isAdmin) listenToLogs();
          renderRoomList();
        });

        // --- ÂèÇÂä†ËÄÖ„É™„Çπ„Éà„ÅÆÁõ£Ë¶ñÈÉ®ÂàÜ ---
        onValue(ref(db, "users"), (snap) => {
          const list = document.getElementById("userList");
          list.innerHTML = `<div class="item-btn"><img src="${BOT_INFO.icon}" class="icon-img"><div>${BOT_INFO.name} [BOT]</div></div>`;

          snap.forEach((c) => {
            const u = c.val();
            const targetUid = c.key; // Áõ∏Êâã„ÅÆID
            const item = document.createElement("div");
            item.className = "item-btn";
            item.innerHTML = `
            <img src="${u.icon}" class="icon-img">
            <div>${u.name} ${
              u.role === 2 ? "üëë" : u.role === 1 ? "‚≠ê" : ""
            }</div>
          `;

            // „ÄêËøΩÂä†„ÄëÁÆ°ÁêÜËÄÖ„Å™„Çâ„ÄÅÂêçÂâç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„É°„Éã„É•„Éº„ÇíÂá∫„Åô
            item.onclick = () => {
              if (isAdmin && targetUid !== myUid) {
                const action = prompt(
                  `„ÄêÁÆ°ÁêÜËÄÖÊìç‰Ωú„Äë\nÂØæË±°Ôºö${u.name}\n\n1: ËøΩÊîæ(„Ç≠„ÉÉ„ÇØ)\n2: ÂâØÁÆ°ÁêÜËÄÖ„Å´‰ªªÂëΩ\n3: ‰∏ÄËà¨„É¶„Éº„Ç∂„Éº„Å´Êàª„Åô\n\nÊï∞Â≠ó„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö`
                );

                if (action === "1") {
                  if (confirm(`${u.name} „Çí„Ç¢„Ç´„Ç¶„É≥„ÉàÂâäÈô§„Åó„Å¶ËøΩÊîæ„Åó„Åæ„Åô„ÅãÔºü`)) {
                    remove(ref(db, `users/${targetUid}`));
                    addAdminLog(
                      `KICK: ${myProfile.name}„Åå ${u.name}„ÇíËøΩÊîæ„Åó„Åæ„Åó„Åü`
                    );
                  }
                } else if (action === "2") {
                  update(ref(db, `users/${targetUid}`), { role: 1 });
                  addAdminLog(`PROMOTED: ${u.name}„ÅåÂâØÁÆ°ÁêÜËÄÖ„Å´ÊòáÊ†º„Åó„Åæ„Åó„Åü`);
                } else if (action === "3") {
                  update(ref(db, `users/${targetUid}`), { role: 0 });
                  addAdminLog(`DEMOTED: ${u.name}„Çí‰∏ÄËà¨„Å´Êàª„Åó„Åæ„Åó„Åü`);
                }
              }
            };
            list.appendChild(item);
          });
        });

        listenToMessages("public");
        // --- „Åì„Åì„Åã„ÇâËøΩÂä† ---
        // Ëá™ÂàÜ„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÅåÂâäÈô§„Åï„Çå„Åü„Çâ„É™„É≠„Éº„ÉâÔºàÂº∑Âà∂„É≠„Ç∞„Ç¢„Ç¶„ÉàÔºâ„Åï„Åõ„Çã
        onValue(ref(db, `users/${myUid}`), (snap) => {
          if (!snap.exists()) {
            alert(
              "„Ç¢„Ç´„Ç¶„É≥„Éà„ÅåÁÆ°ÁêÜËÄÖ„Å´„Çà„Å£„Å¶ÂâäÈô§„Åï„Çå„Åü„Åã„ÄÅ5Êó•Èñì„É≠„Ç∞„Ç§„É≥„Åå„Å™„Åã„Å£„Åü„Åü„ÇÅ„ÄÅËá™ÂãïÁöÑ„Å´„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÄÇ"
            );
            location.reload();
          }
        });
        // --- „Åì„Åì„Åæ„ÅßËøΩÂä† ---
        // startAppÈñ¢Êï∞„ÅÆ‰∏≠
        if (isAdmin) listenToLogs(); // ÁÆ°ÁêÜËÄÖ„Å™„Çâ„É≠„Ç∞Áõ£Ë¶ñ„ÇíÈñãÂßã„Åô„Çã
      }

      function listenToLogs() {
        document.getElementById("logTitle").style.display = "block";
        document.getElementById("adminLog").style.display = "block";
        onValue(ref(db, "admin_logs"), (snap) => {
          const area = document.getElementById("adminLog");
          area.innerHTML = "";
          snap.forEach((c) => {
            const logData = c.val();
            const d = document.createElement("div");
            d.className = "log-msg";
            d.innerText = logData.text; // „É≠„Ç∞„ÅÆÂÜÖÂÆπ„ÇíË°®Á§∫
            area.appendChild(d);
          });
          area.scrollTop = area.scrollHeight;
        });
      }

      function renderRoomList() {
        onValue(
          ref(db, "rooms"),
          (snap) => {
            const rList = document.getElementById("roomList");
            rList.innerHTML = `<div class="item-btn ${
              currentRoomId === "public" ? "active-item" : ""
            }" onclick="listenToMessages('public')">üè† „É≠„Éì„Éº</div>`;
            snap.forEach((c) => {
              const item = document.createElement("div");
              item.className = `item-btn ${
                currentRoomId === c.key ? "active-item" : ""
              }`;
              item.innerHTML = `<div onclick="listenToMessages('${
                c.key
              }')" style="flex:1">üí¨ ${c.val().name}</div>`;
              if (isAdmin) {
                const del = document.createElement("span");
                del.innerText = "√ó";
                del.onclick = () => {
                  remove(ref(db, `rooms/${c.key}`));
                  remove(ref(db, `chat_data/${c.key}`));
                };
                item.appendChild(del);
              }
              rList.appendChild(item);
            });
          },
          { onlyOnce: true }
        );
      }

window.listenToMessages = (roomId) => {
        currentRoomId = roomId;
        renderRoomList();
        onValue(ref(db, `chat_data/${roomId}`), (snap) => {
          const container = document.getElementById("messages");
          container.innerHTML = "";
          snap.forEach((child) => {
            const m = child.val();
            const msgKey = child.key; // ‚òÖ„Åì„Åì„Åß„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆID„ÇíÂõ∫ÂÆö„Åô„Çã
            
            if (m.uid === "system") {
              const s = document.createElement("div");
              s.className = "system-msg";
              s.innerText = m.text;
              container.appendChild(s);
              return;
            }
            
            const isMe = m.uid === myUid;
            const div = document.createElement("div");
            div.className = `msg-box ${isMe ? "my-msg" : ""}`;
            div.innerHTML = `<img src="${m.icon}" class="icon-img"><div class="bubble">${m.text}</div>`;

            // Èï∑Êäº„ÅóÂâäÈô§„ÉªËøî‰ø°
            let t;
            div.onmousedown = div.ontouchstart = (e) => {
              // Âè≥„ÇØ„É™„ÉÉ„ÇØ„ÇÑÈï∑Êäº„ÅóÊôÇ„Å´„Éá„Éï„Ç©„É´„Éà„É°„Éã„É•„Éº„ÇíÂá∫„Åï„Å™„ÅÑ
              if(e.type === 'touchstart') {
                  // „Çπ„Éû„ÉõÁî®Âá¶ÁêÜ
              }

              t = setTimeout(() => {
                const menu = document.getElementById("msgMenu");
                // Ë°®Á§∫‰ΩçÁΩÆ„ÅÆË®àÁÆó
                const x = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                const y = e.clientY || (e.touches ? e.touches[0].clientY : 0);
                
                menu.style.display = "flex";
                menu.style.left = x + "px";
                menu.style.top = y + "px";
                document.getElementById("menuOverlay").style.display = "block";

                // --- ÂâäÈô§„Éú„Çø„É≥„ÅÆÂãï‰ΩúÔºà„Åì„Åì„ÅåÈáçË¶ÅÔºâ ---
                document.getElementById("menuDelete").onclick = () => {
                  const myCurrentRole = (myProfile && myProfile.role) ? myProfile.role : 0;
                  
                  // Ëá™ÂàÜ„ÄÅ„Åæ„Åü„ÅØÁÆ°ÁêÜËÄÖ(2)„ÄÅ„Åæ„Åü„ÅØÂâØÁÆ°ÁêÜËÄÖ(1)„Å™„ÇâÂâäÈô§ÂÆüË°å
                  if (isMe || isAdmin || myCurrentRole === 1) {
                    if (confirm("„Åì„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÆåÂÖ®„Å´Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü")) {
                      // Âõ∫ÂÆö„Åó„ÅümsgKey„Çí‰Ωø„Å£„Å¶„Éî„É≥„Éù„Ç§„É≥„Éà„ÅßÂâäÈô§
                      remove(ref(db, `chat_data/${currentRoomId}/${msgKey}`))
                        .then(() => {
                          addAdminLog(`DELETE: ${myProfile.name}„Åå ${m.name}„ÅÆÊäïÁ®ø„ÇíÊ∂à„Åó„Åæ„Åó„Åü`);
                        })
                        .catch(err => alert("ÂâäÈô§„Ç®„É©„Éº: " + err.message));
                    }
                  } else {
                    alert("„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊ∂à„ÅôÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
                  }
                  closeMenus();
                };

                // Ëøî‰ø°„Éú„Çø„É≥Ôºà‚ÄªËøî‰ø°Ê©üËÉΩ„ÅåÊú™ÂÆüË£Ö„ÅÆÂ†¥Âêà„ÅØalert„ÇíÂá∫„Åô„ÅãÈùûË°®Á§∫„Å´Ôºâ
                document.getElementById("menuReply").onclick = () => {
                  alert("Ëøî‰ø°Ê©üËÉΩ„ÅØÁèæÂú®Ê∫ñÂÇô‰∏≠„Åß„Åô");
                  closeMenus();
                };
              }, 600);
            };
            div.onmouseup = div.ontouchend = () => clearTimeout(t);
            container.appendChild(div);
          });
          container.scrollTop = container.scrollHeight;
        });
      };
            const isMe = m.uid === myUid;
            const div = document.createElement("div");
            div.className = `msg-box ${isMe ? "my-msg" : ""}`;
            div.innerHTML = `<img src="${m.icon}" class="icon-img"><div class="bubble">${m.text}</div>`;

// Èï∑Êäº„ÅóÂâäÈô§„ÉªËøî‰ø°
let t;
            div.onmousedown = div.ontouchstart = (e) => {
              t = setTimeout(() => {
                const menu = document.getElementById("msgMenu");
                const x = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                const y = e.clientY || (e.touches ? e.touches[0].clientY : 0);
                
                menu.style.display = "flex";
                menu.style.left = x + "px";
                menu.style.top = y + "px";
                document.getElementById("menuOverlay").style.display = "block";

                // ÂâäÈô§„Éú„Çø„É≥„ÅÆÂãï‰Ωú„ÇíÂÆöÁæ©
                document.getElementById("menuDelete").onclick = () => {
                  // Ê®©Èôê„ÉÅ„Çß„ÉÉ„ÇØ (isAdmin„ÅØÁÆ°ÁêÜËÄÖ„ÄÅmyRole===1„ÅØÂâØÁÆ°ÁêÜËÄÖ)
                  if (isMe || isAdmin || (myProfile && myProfile.role === 1)) {
                    if (confirm("„Åì„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÆåÂÖ®„Å´Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü")) {
                      remove(ref(db, `chat_data/${currentRoomId}/${child.key}`));
                      addAdminLog(`DELETE: ${myProfile.name}„Åå ${m.name}„ÅÆÊäïÁ®ø„ÇíÊ∂à„Åó„Åæ„Åó„Åü`);
                    }
                  } else {
                    alert("„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÊ∂à„ÅôÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
                  }
                  closeMenus();
                };

                // Ëøî‰ø°„Éú„Çø„É≥
                document.getElementById("menuReply").onclick = () => {
                  setReply(m.name, m.text);
                  closeMenus();
                };
              }, 600);
            };
            div.onmouseup = div.ontouchend = () => clearTimeout(t);
            container.appendChild(div);
          });
          container.scrollTop = container.scrollHeight;
        });
      };

      window.sendMessage = (txt) => {
        if (!txt) return;

        // ÁÆ°ÁêÜËÄÖ„Ç≥„Éû„É≥„Éâ
        if (isAdmin) {
          if (txt.startsWith("/cmd ")) {
            set(ref(db, "announcement"), { text: txt.replace("/cmd ", "") });
            addAdminLog("„Ç¢„Éä„Ç¶„É≥„ÇπÊõ¥Êñ∞");
            return;
          }
          if (txt === "/cmd-off") {
            set(ref(db, "announcement"), null);
            return;
          }
          if (txt === "/nuke") {
            if (confirm("ÂÖ®Ê∂àÂéªÔºü")) remove(ref(db, "chat_data"));
            return;
          }
        }

        // ÈÄöÂ∏∏ÈÄÅ‰ø°
        push(ref(db, `chat_data/${currentRoomId}`), {
          uid: myUid,
          name: myProfile.name,
          icon: myProfile.icon,
          text: txt,
          time: serverTimestamp(),
        });

        // BotÂèçÂøú
        const botRes = getBotResponse(txt);
        if (botRes) {
          setTimeout(() => {
            push(ref(db, `chat_data/${currentRoomId}`), {
              uid: BOT_INFO.uid,
              name: BOT_INFO.name,
              icon: BOT_INFO.icon,
              text: botRes,
              time: serverTimestamp(),
            });
          }, 1000);
        }
        document.getElementById("msgInput").value = "";
      };

      document.getElementById("sendBtn").onclick = () =>
        sendMessage(document.getElementById("msgInput").value);
      document.getElementById("msgInput").onkeydown = (e) => {
        if (e.key === "Enter") sendMessage(e.target.value);
      };

      // Ë®≠ÂÆö & ÁÆ°ÁêÜËÄÖÊòáÊ†º
      const sBtn = document.getElementById("settingsBtn");
      let sTimer;
      sBtn.onmousedown = sBtn.ontouchstart = () => {
        sTimer = setTimeout(() => {
          if (prompt("Admin Pass") === "45454545454519191919191919") {
            update(ref(db, `users/${myUid}`), { role: 2 });
            alert("ÁÆ°ÁêÜËÄÖÊ®©Èôê„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü");
          }
        }, 3000);
      };
      sBtn.onmouseup = sBtn.ontouchend = () => clearTimeout(sTimer);
      sBtn.onclick = () => {
        const newName = prompt("ÂêçÂâçÂ§âÊõ¥", myProfile.name);
        const newIcon = prompt("„Ç¢„Ç§„Ç≥„É≥URLÂ§âÊõ¥", myProfile.icon);
        const up = {};
        if (newName) {
          up.name = newName;
          myProfile.name = newName;
        }
        if (newIcon) {
          up.icon = newIcon;
          myProfile.icon = newIcon;
        }
        update(ref(db, `users/${myUid}`), up);
      };

      document.getElementById("addRoomBtn").onclick = () => {
        if (isAdmin) {
          const n = prompt("ÈÉ®Â±ãÂêç");
          if (n) set(ref(db, `rooms/room-${Date.now()}`), { name: n });
        }
      };

      window.closeMenus = () => {
        document.getElementById("msgMenu").style.display = "none";
        document.getElementById("menuOverlay").style.display = "none";
      };
      document.getElementById("menuOverlay").onclick = closeMenus;

      const switchAuthBtn = document.getElementById("switchAuthBtn");
      switchAuthBtn.onclick = () => {
        isRegisterMode = !isRegisterMode;
        document.getElementById("authTitle").innerText = isRegisterMode
          ? "Êñ∞Ë¶èÁôªÈå≤"
          : "„É≠„Ç∞„Ç§„É≥";
        authSubmitBtn.innerText = isRegisterMode ? "ÁôªÈå≤" : "„É≠„Ç∞„Ç§„É≥";
      };
    </script>
  </body>
</html>
